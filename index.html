<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/433/433424.png" type="faw-icon">
    <title>Mening Kassam - Ultimate Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- GLOBAL --- */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        body { background-color: #0f172a; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        
        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .shake { animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* UI ELEMENTS */
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-modal { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); }
        
        /* Nav Active States */
        .nav-item { color: #64748b; transition: all 0.3s; }
        .nav-item.active { color: #3b82f6 !important; transform: translateY(-2px); }
        .nav-item.active i { stroke-width: 2.5px; }
        
        /* Bot Button Active */
        #nav-bot.active { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        #nav-bot.active i { color: #3b82f6; }

        .filter-active { background-color: #334155 !important; border-color: #475569 !important; color: white !important; }
        
        /* Icon Selection Active */
        .icon-opt.selected { background-color: #2563eb !important; ring: 2px solid white; box-shadow: 0 0 10px rgba(37, 99, 235, 0.5); transform: scale(1.1); }
        .icon-opt.selected i { color: white; }

        /* CHAT STYLES */
        .chat-content { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        .msg-wrapper { display: flex; width: 100%; }
        .msg-wrapper.user { justify-content: flex-end; }
        .msg-wrapper.ai { justify-content: flex-start; }
        
        .msg-bubble { 
            max-width: 80%; 
            padding: 10px 14px; 
            font-size: 14px; 
            line-height: 1.4; 
            position: relative; 
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .msg-bubble.user { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border-radius: 18px 18px 4px 18px; 
        }
        
        .msg-bubble.ai { 
            background: #1e293b; 
            color: #e2e8f0; 
            border-radius: 18px 18px 18px 4px; 
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* AI Sidebar */
        .ai-sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(calc(100% - 48px)); }
        .ai-sidebar.open { transform: translateX(0); }

        /* LIGHT MODE */
        body.light-mode { background-color: #f0f3f6 !important; color: #0f172a; }
        body.light-mode .bg-slate-900, body.light-mode .bg-slate-800 { background-color: #ffffff !important; color: #0f172a !important; border-color: #e2e8f0 !important; }
        body.light-mode .glass-panel { background: rgba(255, 255, 255, 0.9); border-color: #e2e8f0; }
        body.light-mode .text-slate-400 { color: #64748b !important; }
        body.light-mode .text-white { color: #0f172a !important; }
        body.light-mode #bot-input { background: #f1f5f9 !important; color: #0f172a; }
        body.light-mode .cat-btn { background: #f8fafc !important; border-color: #e2e8f0 !important; }
        body.light-mode nav { background: #ffffff !important; border-top-color: #e2e8f0; }
        body.light-mode .bg-slate-700 { background-color: #f1f5f9 !important; color: #0f172a !important; }
        body.light-mode .msg-bubble.ai { background: #f1f5f9; color: #0f172a; border-color: #e2e8f0; }
        
        /* PINS */
        .pin-dot { transition: all 0.2s; }
        .pin-dot.active { transform: scale(1.2); }
    </style>
</head>

<body class="text-slate-100 h-screen flex flex-col overflow-hidden max-w-md mx-auto border-x border-slate-800 shadow-2xl relative">

    <div id="pin-screen" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center hidden">
        <div class="mb-8 text-center fade-in">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30"><i data-lucide="lock" class="w-8 h-8 text-white"></i></div>
            <h2 id="pin-title" class="text-2xl font-bold text-white mb-1">PIN Kod</h2>
            <p id="pin-subtitle" class="text-slate-400 text-sm">Kirish uchun</p>
        </div>
        <div class="flex gap-4 mb-8 fade-in" id="pin-dots">
             <div class="pin-dot w-4 h-4 rounded-full bg-slate-700"></div><div class="pin-dot w-4 h-4 rounded-full bg-slate-700"></div><div class="pin-dot w-4 h-4 rounded-full bg-slate-700"></div><div class="pin-dot w-4 h-4 rounded-full bg-slate-700"></div>
        </div>
        <div class="grid grid-cols-3 gap-6 fade-in mb-6">
            <button onclick="handlePinInput(1)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">1</button>
            <button onclick="handlePinInput(2)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">2</button>
            <button onclick="handlePinInput(3)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">3</button>
            <button onclick="handlePinInput(4)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">4</button>
            <button onclick="handlePinInput(5)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">5</button>
            <button onclick="handlePinInput(6)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">6</button>
            <button onclick="handlePinInput(7)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">7</button>
            <button onclick="handlePinInput(8)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">8</button>
            <button onclick="handlePinInput(9)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">9</button>
            <button onclick="triggerBiometric()" id="bio-btn" class="w-16 h-16 rounded-full bg-transparent text-blue-500 flex items-center justify-center hover:bg-slate-800/50 hidden"><i data-lucide="scan-face" class="w-8 h-8"></i></button>
            <div id="bio-placeholder" class="w-16 h-16 hidden"></div>
            <button onclick="handlePinInput(0)" class="w-16 h-16 rounded-full bg-slate-800 text-2xl font-medium text-white hover:bg-slate-700 transition-colors">0</button>
            <button onclick="handlePinDelete()" class="w-16 h-16 rounded-full bg-transparent text-white hover:bg-slate-800/50 transition-colors flex items-center justify-center"><i data-lucide="delete" class="w-8 h-8"></i></button>
        </div>
        <button id="cancel-pin-setup" onclick="cancelPinSetup()" class="text-slate-400 text-sm hover:text-white hidden">Bekor qilish</button>
    </div>

    <header class="glass-panel rounded-2xl m-2 p-4 flex items-center justify-between z-20 sticky top-2 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="relative">
                <img src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" class="w-10 h-10 rounded-full border-2 border-blue-500 object-cover">
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-800 rounded-full"></div>
            </div>
            <div><div class="text-xs text-slate-400">Assalomu alaykum!</div><div class="font-bold text-sm">Xush kelibsiz ðŸ‘‹</div></div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-700/20"><i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i></button>
            <button onclick="openSettings()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-full text-slate-200"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>
    </header>

    <div id="ai-sidebar" class="ai-sidebar fixed right-0 top-28 z-40 flex items-center justify-end">
        <button onclick="toggleAiSidebar()" class="bg-gradient-to-r from-blue-600 to-violet-600 text-white p-2.5 pl-4 rounded-l-full shadow-xl border-y border-l border-white/10 flex items-center gap-2 active:scale-95">
            <i data-lucide="chevron-left" id="ai-toggle-icon" class="w-5 h-5"></i>
            <span class="text-sm font-bold">AI Tahlil</span>
        </button>
    </div>

    <main id="main-container" class="flex-1 overflow-y-auto relative bg-slate-900 rounded-t-3xl mt-2 pb-24 px-4 pt-6 scroll-smooth">
        
        <div id="view-dashboard" class="space-y-6 fade-in">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl shadow-lg border border-slate-700 relative overflow-hidden">
                <div class="absolute -top-6 -right-6 opacity-10 rotate-12"><i data-lucide="wallet" class="w-40 h-40 text-white"></i></div>
                <h2 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Umumiy Balans</h2>
                <div id="total-balance" class="text-3xl font-bold text-[#2374f8] mb-6 font-mono">0 so'm</div>
                <div class="grid grid-cols-2 gap-3 relative z-10">
                    <div onclick="toggleTypeFilter('income')" id="card-income" class="glass-panel p-3 rounded-2xl flex items-center gap-3 cursor-pointer transition-all hover:bg-emerald-500/10">
                        <div class="p-2 bg-emerald-500 rounded-full text-white shadow-lg shadow-emerald-500/30"><i data-lucide="arrow-down-left" class="w-4 h-4"></i></div>
                        <div class="overflow-hidden"><div class="text-[10px] text-slate-400 uppercase">Kirim</div><div id="total-income" class="font-bold text-emerald-400 text-sm truncate">0</div></div>
                    </div>
                    <div onclick="toggleTypeFilter('expense')" id="card-expense" class="glass-panel p-3 rounded-2xl flex items-center gap-3 cursor-pointer transition-all hover:bg-rose-500/10">
                        <div class="p-2 bg-rose-500 rounded-full text-white shadow-lg shadow-rose-500/30"><i data-lucide="arrow-up-right" class="w-4 h-4"></i></div>
                        <div class="overflow-hidden"><div class="text-[10px] text-slate-400 uppercase">Chiqim</div><div id="total-expense" class="font-bold text-rose-400 text-sm truncate">0</div></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button data-filter="all" onclick="setDateFilter('all')" class="date-filter-btn bg-slate-800 border border-slate-700 text-slate-300 text-xs px-4 py-2 rounded-full shrink-0 font-medium transition-all filter-active">Barchasi</button>
                <button data-filter="week" onclick="setDateFilter('week')" class="date-filter-btn bg-slate-800 border border-slate-700 text-slate-300 text-xs px-4 py-2 rounded-full shrink-0 font-medium transition-all">Hafta</button>
                <button data-filter="month" onclick="setDateFilter('month')" class="date-filter-btn bg-slate-800 border border-slate-700 text-slate-300 text-xs px-4 py-2 rounded-full shrink-0 font-medium transition-all">Oy</button>
                <button onclick="openDateRangeModal()" class="bg-slate-700 text-slate-300 text-xs px-3 py-1.5 rounded-full border border-slate-600 flex items-center gap-1 shrink-0 hover:bg-slate-600"><i data-lucide="calendar" class="w-3 h-3"></i> Sana</button>
            </div>

            <div id="trend-container" class="hidden space-y-3">
                <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider ml-1">Trendlar (O'tgan oyga nisbatan)</h3>
                <div id="trend-list" class="grid grid-cols-2 gap-3"></div>
            </div>

            <div class="glass-panel p-5 rounded-3xl shadow-sm">
                <h3 class="text-slate-200 font-semibold mb-4 flex items-center gap-2 text-sm"><i data-lucide="pie-chart" class="w-4 h-4 text-blue-500"></i> Statistika</h3>
                <div class="h-48 relative flex items-center justify-center"><canvas id="categoryChart"></canvas><div id="no-data-msg" class="absolute text-slate-500 text-xs hidden">Ma'lumot yo'q</div></div>
            </div>
            
            <div class="glass-panel p-5 rounded-3xl shadow-sm">
                <h3 class="text-slate-200 font-semibold mb-4 text-sm">Top 5 Operatsiyalar</h3>
                <table class="w-full text-left text-sm"><tbody id="top-transaction-list" class="divide-y divide-slate-700/50"></tbody></table>
            </div>
        </div>

        <div id="view-bot" class="flex flex-col h-full hidden fade-in relative">
            <div class="text-center text-xs text-slate-500 py-2 bg-slate-900/50 backdrop-blur-sm absolute top-0 w-full z-10 border-b border-slate-800">Yordamchi Bot</div>
            <div class="flex-1 overflow-y-auto p-2 pt-10 pb-32 chat-content" id="chat-messages">
                 <div class="msg-wrapper ai fade-in"><div class="msg-bubble ai">Assalomu alaykum! Qaysi operatsiyani bajaramiz? ðŸ“¸</div></div>
            </div>

            <div class="p-4 bg-slate-800/95 backdrop-blur-xl border-t border-slate-700 absolute bottom-0 left-0 right-0 z-20 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.3)]">
                
                <div id="bot-start-actions">
                    <div class="text-center text-[10px] font-bold text-slate-500 mb-3 uppercase tracking-widest">Kirim / Chiqim</div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="startBotFlow('income')" class="bg-emerald-500/10 p-4 rounded-2xl border border-emerald-500/20 flex flex-col items-center justify-center gap-2 transition-all active:scale-95 group hover:bg-emerald-500/20">
                            <div class="bg-emerald-500 text-white p-3 rounded-full shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform"><i data-lucide="arrow-down-left" class="w-6 h-6"></i></div>
                            <span class="text-emerald-400 font-bold">Kirim</span>
                        </button>
                        <button onclick="startBotFlow('expense')" class="bg-rose-500/10 p-4 rounded-2xl border border-rose-500/20 flex flex-col items-center justify-center gap-2 transition-all active:scale-95 group hover:bg-rose-500/20">
                            <div class="bg-rose-500 text-white p-3 rounded-full shadow-lg shadow-rose-500/30 group-hover:scale-110 transition-transform"><i data-lucide="arrow-up-right" class="w-6 h-6"></i></div>
                            <span class="text-rose-400 font-bold">Chiqim</span>
                        </button>
                    </div>
                </div>

                <div id="bot-input-container" class="hidden flex flex-col gap-3">
                    <div id="receipt-preview-area" class="hidden flex items-center gap-3 bg-slate-700/50 p-2 rounded-xl border border-slate-600">
                        <div class="w-12 h-12 bg-slate-800 rounded-lg overflow-hidden flex-shrink-0"><img id="receipt-img-preview" class="w-full h-full object-cover"></div>
                        <div class="flex-1 text-xs text-emerald-400 font-medium">Chek biriktirildi</div>
                        <button onclick="clearReceipt()" class="p-2 text-rose-400 hover:bg-slate-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>

                    <div class="flex gap-2 items-center relative">
                        <button onclick="document.getElementById('file-upload').click()" class="p-3 bg-slate-700 rounded-xl text-blue-400 hover:text-white hover:bg-slate-600 transition-colors"><i data-lucide="camera" class="w-5 h-5"></i></button>
                        <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleReceiptUpload(event)">
                        
                        <div class="flex-1 relative">
                            <input type="text" id="bot-input" class="w-full bg-slate-700 text-white rounded-xl pl-4 pr-10 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Summani kiriting..." autocomplete="off">
                            <button onclick="cancelBotFlow()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-400 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                        </div>
                        <button onclick="submitBotInput()" class="bg-blue-600 text-white p-3 rounded-xl shadow-lg shadow-blue-600/30 hover:bg-blue-500 active:scale-95 transition-transform"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <div id="category-selector" class="hidden pt-4 relative">
                     <div class="flex justify-between items-center mb-3 px-1">
                        <span class="text-slate-400 text-xs font-bold uppercase">Kategoriya tanlang</span>
                        <button onclick="openAddCategoryModal()" class="text-blue-400 text-xs font-bold flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Yangi</button>
                    </div>
                    <div class="text-[10px] text-slate-500 mb-2 italic text-center">Tahrirlash uchun ustiga bosib turing</div>
                    <div id="category-grid" class="grid grid-cols-4 gap-2 max-h-48 overflow-y-auto pb-2"></div>
                    <button onclick="cancelBotFlow()" class="absolute -top-2 right-0 p-2 text-slate-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>

        <div id="view-debt" class="hidden fade-in space-y-4">
            <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-white">Qarz Daftari</h2><button onclick="openDebtModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-blue-500 transition-colors">+ Qo'shish</button></div>
            <div class="flex bg-slate-800 p-1 rounded-xl border border-slate-700 mb-4"><button onclick="switchDebtTab('given')" id="debt-tab-given" class="flex-1 py-2 text-xs font-bold rounded-lg bg-slate-700 text-white shadow transition-all">Berganman</button><button onclick="switchDebtTab('taken')" id="debt-tab-taken" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-slate-200 transition-all">Olganman</button></div>
            <div id="debt-list" class="space-y-3 pb-24"></div>
            <div id="empty-debt" class="hidden flex flex-col items-center justify-center py-10 text-slate-500"><i data-lucide="check-circle" class="w-12 h-12 mb-2 opacity-30"></i><p class="text-sm mt-2">Qarzlar yo'q</p></div>
        </div>

        <div id="view-history" class="hidden fade-in space-y-4">
            <h2 class="text-lg font-bold text-white mb-2">Tarix</h2>
            <div id="history-list" class="space-y-3 pb-24"></div>
            <div id="empty-history" class="hidden flex flex-col items-center justify-center py-10 text-slate-500"><i data-lucide="clipboard-list" class="w-12 h-12 mb-2 opacity-30"></i><p class="text-sm mt-2">Ma'lumot yo'q</p></div>
        </div>
    </main>

    <nav class="glass-panel fixed bottom-0 left-0 right-0 rounded-t-2xl flex justify-around py-3 px-2 z-30 max-w-md mx-auto shadow-[0_-4px_20px_rgba(0,0,0,0.2)]">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 w-14 nav-item active"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-[9px] font-bold">Asosiy</span></button>
        <button onclick="switchTab('bot')" id="nav-bot" class="relative -top-6 bg-slate-800 border-4 border-slate-900 w-14 h-14 rounded-full flex items-center justify-center text-slate-400 shadow-lg transition-all"><i data-lucide="plus" class="w-6 h-6"></i></button>
        <button onclick="switchTab('debt')" id="nav-debt" class="flex flex-col items-center gap-1 w-14 nav-item"><i data-lucide="book" class="w-5 h-5"></i><span class="text-[9px] font-bold">Qarz</span></button>
        <button onclick="switchTab('history')" id="nav-history" class="flex flex-col items-center gap-1 w-14 nav-item"><i data-lucide="history" class="w-5 h-5"></i><span class="text-[9px] font-bold">Tarix</span></button>
    </nav>

    <div id="action-sheet" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-end justify-center" onclick="closeActionSheet(event)">
        <div class="bg-slate-800 w-full max-w-md rounded-t-2xl p-5 border-t border-slate-700 slide-up shadow-2xl" onclick="event.stopPropagation()">
            <div class="w-12 h-1 bg-slate-600 rounded-full mx-auto mb-6"></div>
            <div id="action-sheet-content" class="space-y-3"></div>
            <button onclick="closeActionSheet(null)" class="mt-4 w-full py-3.5 bg-slate-900 rounded-xl text-slate-400 font-bold text-sm">Yopish</button>
        </div>
    </div>
    
    <div id="cat-context-menu" class="fixed z-[60] hidden bg-slate-800 border border-slate-700 rounded-xl shadow-2xl overflow-hidden w-40 scale-in">
        <button onclick="editCatFromMenu()" class="w-full text-left px-4 py-3 hover:bg-slate-700 text-blue-400 text-sm font-medium flex items-center gap-2"><i data-lucide="edit-2" class="w-4 h-4"></i> Tahrirlash</button>
        <button onclick="deleteCatFromMenu()" class="w-full text-left px-4 py-3 hover:bg-slate-700 text-rose-400 text-sm font-medium flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> O'chirish</button>
    </div>

    <div id="receipt-modal" class="fixed inset-0 bg-black/95 z-[90] hidden flex items-center justify-center p-2" onclick="closeReceiptModal()"><button class="absolute top-4 right-4 p-2 bg-white/10 rounded-full text-white"><i data-lucide="x" class="w-6 h-6"></i></button><img id="full-receipt-image" class="max-w-full max-h-[85vh] rounded shadow-2xl object-contain"></div>
    <div id="gemini-modal" class="fixed inset-0 z-[60] hidden flex flex-col glass-modal slide-up"><div class="p-4 border-b border-white/10 flex items-center justify-between bg-white/5"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center shadow-lg"><i data-lucide="sparkles" class="w-5 h-5 text-white"></i></div><div><h3 class="font-bold text-white">Gemini AI</h3><p class="text-[10px] text-emerald-400">Online</p></div></div><button onclick="toggleAiSidebar()" class="p-2"><i data-lucide="x" class="text-slate-400"></i></button></div><div id="ai-chat-area" class="flex-1 overflow-y-auto p-4 space-y-4 chat-content"></div><div class="p-4 bg-slate-900/80 border-t border-white/10"><div class="flex gap-2 bg-slate-800/50 p-1.5 rounded-3xl border border-white/5"><input type="text" id="ai-input" placeholder="Savol..." class="flex-1 bg-transparent text-white px-4 py-3 outline-none text-sm"><button onclick="sendToGemini()" class="bg-blue-600 text-white p-3 rounded-2xl"><i data-lucide="send" class="w-5 h-5"></i></button></div></div></div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700 slide-up"><div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-white">Sozlamalar</h3><button onclick="closeModal('settings-modal')"><i data-lucide="x" class="text-slate-400"></i></button></div><div class="space-y-3"><div class="bg-slate-700 rounded-xl p-1 overflow-hidden mb-4"><button onclick="startPinSetup()" class="w-full p-4 flex items-center justify-between hover:bg-slate-600 transition-colors rounded-lg"><div class="flex items-center gap-3"><div class="p-2 bg-blue-500/20 rounded-lg text-blue-400"><i data-lucide="lock" class="w-5 h-5"></i></div><div><div class="text-white text-sm font-bold">PIN Kod</div><div id="pin-status-text" class="text-xs text-slate-400"></div></div></div><i data-lucide="chevron-right" class="w-4 h-4 text-slate-500"></i></button><button id="btn-remove-pin" onclick="removePin()" class="w-full p-4 flex items-center justify-between hover:bg-slate-600 transition-colors rounded-lg border-t border-slate-600 hidden"><div class="flex items-center gap-3"><div class="p-2 bg-rose-500/20 rounded-lg text-rose-400"><i data-lucide="unlock" class="w-5 h-5"></i></div><div class="text-white text-sm font-bold text-rose-400">PINni o'chirish</div></div></button><div class="h-[1px] bg-slate-600 mx-4"></div><div id="bio-row" class="p-4 flex items-center justify-between hidden"><div class="flex items-center gap-3"><div class="p-2 bg-purple-500/20 rounded-lg text-purple-400"><i data-lucide="scan-face" class="w-5 h-5"></i></div><div class="text-white text-sm font-bold">Face ID / Touch ID</div></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="bio-toggle" class="sr-only peer" onchange="toggleBiometric(this)"><div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div></div><div class="grid grid-cols-2 gap-3"><button onclick="exportData()" class="p-4 bg-slate-700 rounded-xl flex flex-col items-center gap-2 hover:bg-slate-600"><i data-lucide="download" class="text-emerald-400"></i><span class="text-xs text-slate-300 font-bold">Backup</span></button><button onclick="document.getElementById('import-file').click()" class="p-4 bg-slate-700 rounded-xl flex flex-col items-center gap-2 hover:bg-slate-600"><i data-lucide="upload" class="text-blue-400"></i><span class="text-xs text-slate-300 font-bold">Tiklash</span></button><input type="file" id="import-file" class="hidden" onchange="importData(event)" accept=".json"></div><button onclick="confirmResetData()" class="w-full p-4 bg-rose-900/20 text-rose-400 rounded-xl flex items-center justify-center gap-2 mt-2 hover:bg-rose-900/30"><i data-lucide="trash-2" class="w-4 h-4"></i> Tozalash</button></div></div></div>
    <div id="edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-5 w-full max-w-sm border border-slate-700"><h3 class="text-lg font-bold text-white mb-4">Tahrirlash</h3><div class="space-y-3"><input type="text" id="edit-category" class="w-full bg-slate-700 rounded-xl p-3 text-white outline-none border border-slate-600"><input type="number" id="edit-amount" class="w-full bg-slate-700 rounded-xl p-3 text-white outline-none border border-slate-600"><select id="edit-type" class="w-full bg-slate-700 rounded-xl p-3 text-white outline-none border border-slate-600"><option value="income">Kirim (+)</option><option value="expense">Chiqim (-)</option></select></div><div class="flex gap-3 mt-6"><button onclick="closeModal('edit-modal')" class="flex-1 py-3 bg-slate-700 rounded-xl text-slate-300">Bekor</button><button onclick="saveEdit()" class="flex-1 py-3 bg-blue-600 rounded-xl text-white font-bold">Saqlash</button></div></div></div>
    <div id="delete-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-5 w-full max-w-sm border border-slate-700 text-center"><h3 class="text-lg font-bold text-white mb-2">O'chirish</h3><p class="text-slate-400 text-sm mb-6">Ushbu operatsiyani rostdan ham o'chirmoqchimisiz?</p><div class="flex gap-3"><button onclick="closeModal('delete-modal')" class="flex-1 py-3 bg-slate-700 rounded-xl text-slate-300">Bekor</button><button onclick="confirmDelete()" class="flex-1 py-3 bg-rose-600 rounded-xl text-white font-bold">O'chirish</button></div></div></div>
    
    <div id="debt-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700"><h3 class="text-white font-bold mb-4">Qarz Qo'shish</h3><input id="debt-name" placeholder="Kim" class="w-full bg-slate-700 text-white p-3 rounded-xl mb-3 outline-none border border-slate-600"><input type="number" id="debt-amount" placeholder="Summa" class="w-full bg-slate-700 text-white p-3 rounded-xl mb-3 outline-none border border-slate-600"><input type="date" id="debt-date" class="w-full bg-slate-700 rounded-xl p-3 text-white outline-none border border-slate-600 mb-3"><div class="flex gap-2 mb-4"><button onclick="setDebtType('given')" id="btn-type-given" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs">Men berdim</button><button onclick="setDebtType('taken')" id="btn-type-taken" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-400 font-bold text-xs">Men oldim</button></div><div class="flex gap-3"><button onclick="closeModal('debt-modal')" class="flex-1 bg-slate-700 py-3 rounded-xl text-slate-300">Bekor</button><button onclick="saveDebt()" class="flex-1 bg-emerald-600 py-3 rounded-xl text-white font-bold">Saqlash</button></div></div></div>
    <div id="add-cat-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700"><h3 class="text-lg font-bold text-white mb-4">Yangi Kategoriya</h3><input type="text" id="new-cat-name" placeholder="Nomi" class="w-full bg-slate-700 rounded-xl p-3 text-white border border-slate-600 mb-4 focus:border-blue-500 outline-none"><div class="grid grid-cols-5 gap-2 mb-6" id="icon-selector"></div><div class="flex gap-3"><button onclick="closeModal('add-cat-modal')" class="flex-1 py-3 bg-slate-700 rounded-xl text-slate-300">Bekor</button><button onclick="saveNewCategory()" class="flex-1 py-3 bg-blue-600 rounded-xl text-white font-bold">Saqlash</button></div></div></div>
    <div id="edit-cat-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[75] hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700"><h3 class="text-lg font-bold text-white mb-4">Kategoriyani Tahrirlash</h3><input type="text" id="edit-cat-name-input" class="w-full bg-slate-700 rounded-xl p-3 text-white border border-slate-600 mb-4 outline-none"><div class="flex gap-3"><button onclick="closeModal('edit-cat-modal')" class="flex-1 py-3 bg-slate-700 rounded-xl text-slate-300">Bekor</button><button onclick="confirmEditCat()" class="flex-1 py-3 bg-blue-600 rounded-xl text-white font-bold">Saqlash</button></div></div></div>
    <div id="date-range-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-white">Maxsus Sana</h3><button onclick="closeModal('date-range-modal')" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="space-y-4"><input type="date" id="start-date" class="w-full bg-slate-700 rounded-xl p-3 text-white outline-none border border-slate-600"><input type="date" id="end-date" class="w-full bg-slate-700 rounded-xl p-3 text-white outline-none border border-slate-600"></div><button onclick="applyDateRange()" class="mt-6 w-full bg-blue-600 py-3 rounded-xl text-white font-bold">Qo'llash</button></div></div>

    <script>
        // --- CONFIG ---
        const GEMINI_API_KEY = "AIzaSyCR97UX69UFaHQ984x0ACsrCNJRIjbNSto"; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const default_income = [{name:"Oylik",icon:"banknote"},{name:"Bonus",icon:"gift"},{name:"Biznes",icon:"briefcase"},{name:"Sotuv",icon:"shopping-bag"}];
        const default_expense = [{name:"Oziq-ovqat",icon:"shopping-cart"},{name:"Transport",icon:"bus"},{name:"Ijara",icon:"home"},{name:"Kiyim",icon:"shirt"},{name:"Kafe",icon:"coffee"},{name:"Dorixona",icon:"pill"}];
        const icons = ['shopping-cart','zap','wifi','smartphone','car','home','gift','coffee','music','book','heart','smile','star','briefcase','credit-card','monitor','tool','truck','shopping-bag','banknote','pill','shirt'];

        // --- STATE ---
        let allCats = JSON.parse(localStorage.getItem('categories')) || { income: default_income, expense: default_expense };
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let debts = JSON.parse(localStorage.getItem('debts')) || [];
        let pin = localStorage.getItem('pin'), bioEnabled = localStorage.getItem('bio')==='true';
        let activeType='all', activeDate='all', activeDebt='given', botState='idle', draft={receipt:null}, selId=null, selIcon='circle';
        let pinInput="", pinStep='unlock', tempPin="";
        let selCatIndex = null, selCatType = null;
        let isBiometricAvailable = false;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            // Check Biometrics Support
            isBiometricAvailable = window.PublicKeyCredential && 
                                   await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
            
            if(pin) {
                showPinScreen('unlock');
            }
            if(localStorage.getItem('theme')==='light') toggleTheme(true);
            updateUI(); 
            
            const navDash = document.getElementById('nav-dashboard');
            if(navDash) navDash.classList.add('active');
            
            updateSettingsUI();
            
            const ic = document.getElementById('icon-selector');
            icons.forEach(i => {
                const d = document.createElement('div');
                d.className = "p-2 rounded-lg bg-slate-700 flex items-center justify-center cursor-pointer icon-opt transition-all";
                d.innerHTML = `<i data-lucide="${i}" class="w-5 h-5 text-slate-300 pointer-events-none"></i>`;
                d.onclick = () => { document.querySelectorAll('.icon-opt').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); selIcon=i; };
                ic.appendChild(d);
            });
            
            window.addEventListener('click', () => document.getElementById('cat-context-menu').classList.add('hidden'));
        });

        // --- NAVIGATION LOGIC ---
        function switchTab(t) {
            ['dashboard','bot','debt','history'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const botBtn = document.getElementById('nav-bot');
            botBtn.classList.remove('active');
            botBtn.querySelector('i').classList.remove('text-blue-500');
            botBtn.querySelector('i').classList.add('text-white');

            if(t === 'bot') {
                botBtn.classList.add('active');
                botBtn.querySelector('i').classList.remove('text-white');
                botBtn.querySelector('i').classList.add('text-blue-500');
            } else {
                const activeBtn = document.getElementById(`nav-${t}`);
                if(activeBtn) activeBtn.classList.add('active');
            }
            if(t==='dashboard') updateUI();
            lucide.createIcons();
        }

        // --- CATEGORY MANAGEMENT ---
        let longPressTimer;
        function handleCatPressStart(e, idx, type) {
            longPressTimer = setTimeout(() => showCatOptions(e, idx, type), 500);
        }
        function handleCatPressEnd() { clearTimeout(longPressTimer); }
        
        function showCatOptions(e, idx, type) {
            e.preventDefault();
            selCatIndex = idx; selCatType = type;
            const menu = document.getElementById('cat-context-menu');
            const clickX = e.clientX || e.touches[0].clientX;
            const clickY = e.clientY || e.touches[0].clientY;
            menu.style.left = `${Math.min(clickX, window.innerWidth - 170)}px`;
            menu.style.top = `${Math.min(clickY, window.innerHeight - 100)}px`;
            menu.classList.remove('hidden');
        }

        function editCatFromMenu() {
            const cat = allCats[selCatType][selCatIndex];
            document.getElementById('edit-cat-name-input').value = cat.name;
            document.getElementById('edit-cat-modal').classList.remove('hidden');
            document.getElementById('cat-context-menu').classList.add('hidden');
        }
        
        function confirmEditCat() {
            const newName = document.getElementById('edit-cat-name-input').value;
            if(newName) {
                allCats[selCatType][selCatIndex].name = newName;
                saveCats(); renderBotCats(selCatType); closeModal('edit-cat-modal');
            }
        }

        function deleteCatFromMenu() {
            if(confirm("Bu kategoriyani o'chirasizmi?")) {
                allCats[selCatType].splice(selCatIndex, 1);
                saveCats(); renderBotCats(selCatType);
                document.getElementById('cat-context-menu').classList.add('hidden');
            }
        }
        function saveCats() { localStorage.setItem('categories', JSON.stringify(allCats)); }

        // --- PIN & BIOMETRICS LOGIC ---
        function showPinScreen(step) {
            pinStep = step; pinInput = ""; updatePinDots();
            document.getElementById('pin-screen').classList.remove('hidden');
            const t = document.getElementById('pin-title'), s = document.getElementById('pin-subtitle'), c = document.getElementById('cancel-pin-setup');
            const bioBtn = document.getElementById('bio-btn'), bioPlace = document.getElementById('bio-placeholder');
            
            if(step==='unlock') {
                t.innerText="PIN Kod"; s.innerText="Kirish uchun"; c.classList.add('hidden');
                if(bioEnabled && isBiometricAvailable) { 
                    bioBtn.classList.remove('hidden'); bioPlace.classList.add('hidden'); 
                    setTimeout(triggerBiometric, 300);
                } else { 
                    bioBtn.classList.add('hidden'); bioPlace.classList.remove('hidden'); 
                }
            } else if(step==='setup_old') {
                t.innerText="Eski PIN"; s.innerText="Tasdiqlash uchun"; c.classList.remove('hidden');
                bioBtn.classList.add('hidden'); bioPlace.classList.remove('hidden');
            } else if(step==='setup_new') {
                t.innerText="Yangi PIN"; s.innerText="4 xonali kod o'rnating"; c.classList.remove('hidden');
                bioBtn.classList.add('hidden'); bioPlace.classList.remove('hidden');
            } else if(step==='setup_confirm') {
                 t.innerText="Qayta kiritish"; s.innerText="Yangi PINni tasdiqlang";
            }
        }

        function handlePinInput(n) { if(pinInput.length<4) { pinInput+=n; updatePinDots(); if(pinInput.length===4) setTimeout(checkPin,200); } }
        function handlePinDelete() { pinInput=pinInput.slice(0,-1); updatePinDots(); }
        function updatePinDots() { document.querySelectorAll('.pin-dot').forEach((d,i)=>i<pinInput.length?d.classList.add('bg-blue-500','active','scale-110'):d.classList.remove('bg-blue-500','active','scale-110')); }
        
        function checkPin() {
            const d = document.getElementById('pin-dots');
            const err = () => { d.classList.add('shake'); setTimeout(()=>{d.classList.remove('shake'); pinInput=""; updatePinDots();},400); };
            if(pinStep==='unlock') { 
                if(pinInput===pin) { document.getElementById('pin-screen').classList.add('hidden'); } else err(); 
            } else if(pinStep==='setup_old') { 
                if(pinInput===pin) { showPinScreen('setup_new'); } else err(); 
            } else if(pinStep==='setup_new') { 
                tempPin = pinInput; showPinScreen('setup_confirm'); 
            } else if(pinStep==='setup_confirm') { 
                if(pinInput===tempPin) { 
                    pin=tempPin; localStorage.setItem('pin',pin); 
                    document.getElementById('pin-screen').classList.add('hidden'); 
                    updateSettingsUI(); alert("PIN o'zgartirildi! âœ…"); 
                    closeModal('settings-modal'); 
                } else { 
                    alert("Mos kelmadi!"); showPinScreen('setup_new'); 
                } 
            }
        }

        async function triggerBiometric() {
            if (!isBiometricAvailable) return;
            try {
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                await navigator.credentials.get({
                    publicKey: {
                        challenge: challenge,
                        timeout: 60000,
                        userVerification: "required", 
                    }
                });
                document.getElementById('pin-screen').classList.add('hidden');
            } catch (e) {
                console.log("Biometric failed or cancelled", e);
            }
        }

        function startPinSetup() { if(pin) showPinScreen('setup_old'); else showPinScreen('setup_new'); }
        function cancelPinSetup() { document.getElementById('pin-screen').classList.add('hidden'); }
        function toggleBiometric(el) { bioEnabled = el.checked; localStorage.setItem('bio', bioEnabled); }
        function removePin() { if(confirm("PIN kodni olib tashlaysizmi?")) { localStorage.removeItem('pin'); pin = null; updateSettingsUI(); alert("PIN kod olib tashlandi."); closeModal('settings-modal'); } }

        // --- IMAGE OPTIMIZATION ---
        function handleReceiptUpload(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const maxW = 800; const scale = maxW / img.width;
                    canvas.width = scale < 1 ? maxW : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    draft.receipt = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('receipt-img-preview').src = draft.receipt;
                    document.getElementById('receipt-preview-area').classList.remove('hidden');
                }
            }; reader.readAsDataURL(file);
        }
        function clearReceipt() { draft.receipt=null; document.getElementById('file-upload').value=''; document.getElementById('receipt-preview-area').classList.add('hidden'); }
        function viewReceipt(src) { document.getElementById('full-receipt-image').src = src; document.getElementById('receipt-modal').classList.remove('hidden'); }
        function closeReceiptModal() { document.getElementById('receipt-modal').classList.add('hidden'); }

        // --- CORE UI ---
        function updateUI() {
            const {s,e} = getDateRange(); transactions.sort((a,b) => b.date - a.date);
            const f = transactions.filter(t=>t.date>=s && t.date<=e);
            const inc = f.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
            const exp = f.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            document.getElementById('total-balance').innerText = formatNumber(inc-exp) + " so'm";
            document.getElementById('total-income').innerText = "+" + formatNumber(inc);
            document.getElementById('total-expense').innerText = "-" + formatNumber(exp);
            updateTrendWidgets();
            const ci = document.getElementById('card-income'), ce = document.getElementById('card-expense');
            ci.className = `glass-panel p-3 rounded-2xl flex items-center gap-3 cursor-pointer transition-all ${activeType==='income'?'bg-emerald-500/20 border-emerald-500':'hover:bg-emerald-500/10'}`;
            ce.className = `glass-panel p-3 rounded-2xl flex items-center gap-3 cursor-pointer transition-all ${activeType==='expense'?'bg-rose-500/20 border-rose-500':'hover:bg-rose-500/10'}`;
            renderCharts(f); renderHistory();
        }
        
        function updateTrendWidgets() {
            const now = new Date(); const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth()-1, 1).getTime(); const lastMonthEnd = thisMonthStart - 1;
            const thisMonthTrans = transactions.filter(t => t.date >= thisMonthStart && t.type === 'expense');
            const lastMonthTrans = transactions.filter(t => t.date >= lastMonthStart && t.date <= lastMonthEnd && t.type === 'expense');
            const group = (arr) => arr.reduce((acc, t) => { acc[t.category] = (acc[t.category]||0) + t.amount; return acc; }, {});
            const curr = group(thisMonthTrans); const prev = group(lastMonthTrans);
            let html = ''; const cats = [...new Set([...Object.keys(curr), ...Object.keys(prev)])];
            if(cats.length > 0) {
                document.getElementById('trend-container').classList.remove('hidden');
                cats.forEach(c => {
                    const cVal = curr[c] || 0; const pVal = prev[c] || 0;
                    if (pVal > 0 && cVal > 0) {
                        const pct = ((cVal - pVal) / pVal) * 100;
                        if(Math.abs(pct) > 5) {
                            const isBad = pct > 0; const color = isBad ? 'text-rose-400' : 'text-emerald-400'; const icon = isBad ? 'trending-up' : 'trending-down';
                            html += `<div class="glass-panel p-3 rounded-xl flex justify-between items-center"><div><div class="text-xs text-slate-400">${c}</div><div class="font-bold text-sm text-white">${formatNumber(cVal)}</div></div><div class="text-right"><div class="${color} font-bold text-xs flex items-center gap-1 justify-end"><i data-lucide="${icon}" class="w-3 h-3"></i> ${Math.round(Math.abs(pct))}%</div><div class="text-xs text-slate-500">o'tgan oy</div></div></div>`;
                        }
                    }
                });
            }
            document.getElementById('trend-list').innerHTML = html || '<div class="col-span-2 text-center text-xs text-slate-500 py-2">Trendlar uchun ma\'lumot yetarli emas</div>';
        }

        function renderCharts(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            let t = activeType === 'income' ? data.filter(x => x.type === 'income') : data.filter(x => x.type === 'expense');
            if(activeType === 'all') t = data.filter(x => x.type === 'expense');
            document.getElementById('no-data-msg').classList.toggle('hidden', t.length > 0);
            const cats = {}; t.forEach(x=>cats[x.category]=(cats[x.category]||0)+x.amount);
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#10b981','#ef4444','#f59e0b','#3b82f6','#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } });
            const list = document.getElementById('top-transaction-list'); list.innerHTML = '';
            Object.entries(cats).sort(([,a],[,b])=>b-a).slice(0,5).forEach(([c,a])=>{ list.innerHTML += `<tr><td class="py-2.5 text-slate-300 capitalize pl-2">${c}</td><td class="text-right font-bold pr-2 ${activeType==='income'?'text-emerald-400':'text-rose-400'}">${formatNumber(a)}</td></tr>`; });
        }

        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            document.getElementById('empty-history').classList.toggle('hidden', transactions.length > 0);
            transactions.forEach(t => {
                const isInc = t.type === 'income';
                const receiptBadge = t.receipt ? `<span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30 flex items-center gap-0.5"><i data-lucide="paperclip" class="w-2 h-2"></i> Chek</span>` : '';
                list.innerHTML += `<div onclick="openActionSheet(event, ${t.id})" class="glass-panel p-4 rounded-2xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform hover:bg-slate-800/50"><div class="flex items-center gap-4"><div class="p-3 rounded-full ${isInc?'bg-emerald-500/10 text-emerald-400':'bg-rose-500/10 text-rose-400'}"><i data-lucide="${isInc?'arrow-down-left':'arrow-up-right'}" class="w-5 h-5"></i></div><div><div class="font-bold text-sm text-white capitalize flex items-center">${t.category} ${receiptBadge}</div><div class="text-xs text-slate-400 mt-0.5">${new Date(t.date).toLocaleDateString()} â€¢ ${new Date(t.date).toLocaleTimeString().slice(0,5)}</div></div></div><div class="font-bold ${isInc?'text-emerald-400':'text-rose-400'} text-base">${isInc?'+':'-'}${formatNumber(t.amount)}</div></div>`;
            });
            lucide.createIcons();
        }

        // --- BOT FLOW ---
        function startBotFlow(type) { draft = { type, category:'', amount:0, receipt:null }; clearReceipt(); document.getElementById('bot-start-actions').classList.add('hidden'); document.getElementById('category-selector').classList.remove('hidden'); renderBotCats(type); }
        function renderBotCats(type) {
            const grid = document.getElementById('category-grid'); grid.innerHTML = '';
            allCats[type].forEach((c, idx) => {
                const btn = document.createElement('button');
                btn.className = "cat-btn flex flex-col items-center justify-center p-3 rounded-2xl bg-slate-800 border border-slate-700 hover:border-blue-500 transition-all active:scale-95 select-none";
                btn.innerHTML = `<i data-lucide="${c.icon}" class="w-6 h-6 mb-1 ${type==='income'?'text-emerald-400':'text-rose-400'} pointer-events-none"></i><span class="text-[10px] text-slate-300 truncate w-full text-center pointer-events-none">${c.name}</span>`;
                btn.onclick = () => { draft.category = c.name; document.getElementById('category-selector').classList.add('hidden'); document.getElementById('bot-input-container').classList.remove('hidden'); document.getElementById('bot-input').focus(); };
                btn.oncontextmenu = (e) => showCatOptions(e, idx, type);
                btn.ontouchstart = (e) => handleCatPressStart(e, idx, type);
                btn.ontouchend = handleCatPressEnd;
                grid.appendChild(btn);
            });
            lucide.createIcons();
        }
        
        function submitBotInput() { 
            const val = parseInt(document.getElementById('bot-input').value); 
            if(!val) return; 
            transactions.unshift({ id: Date.now(), date: Date.now(), type: draft.type, category: draft.category, amount: val, receipt: draft.receipt }); 
            localStorage.setItem('transactions', JSON.stringify(transactions)); 
            document.getElementById('bot-input').value=''; 
            cancelBotFlow(); 
            
            const icon = draft.receipt ? 'ðŸ“Ž' : ''; 
            const chat = document.getElementById('chat-messages');
            
            chat.innerHTML += `
            <div class="msg-wrapper ai fade-in">
                <div class="msg-bubble ai border-l-4 ${draft.type==='income'?'border-l-emerald-500':'border-l-rose-500'}">
                    Saqlandi: <b>${formatNumber(val)} so'm</b> ${icon} <br>
                    <span class="text-xs opacity-70">${draft.category}</span>
                </div>
            </div>`; 
            
            updateUI(); 
            setTimeout(() => chat.scrollTop = chat.scrollHeight, 100);
        }
        
        function cancelBotFlow() { document.getElementById('bot-input-container').classList.add('hidden'); document.getElementById('category-selector').classList.add('hidden'); document.getElementById('bot-start-actions').classList.remove('hidden'); clearReceipt(); }

        // --- HELPERS ---
        function toggleTheme(f) { const l = f || document.body.classList.toggle('light-mode'); localStorage.setItem('theme', l?'light':'dark'); lucide.createIcons(); }
        function openAddCategoryModal() { document.getElementById('add-cat-modal').classList.remove('hidden'); }
        function saveNewCategory() { const n = document.getElementById('new-cat-name').value; if(n && draft.type) { allCats[draft.type].push({name:n, icon:selIcon}); saveCats(); renderBotCats(draft.type); closeModal('add-cat-modal'); } }
        
        function openSettings() { 
            updateSettingsUI(); 
            document.getElementById('settings-modal').classList.remove('hidden'); 
        }
        
        function updateSettingsUI() { 
            document.getElementById('pin-status-text').innerText = pin ? "Faol" : "O'rnatilmagan"; 
            document.getElementById('bio-toggle').checked = bioEnabled; 
            const removeBtn = document.getElementById('btn-remove-pin');
            if(pin) removeBtn.classList.remove('hidden'); else removeBtn.classList.add('hidden');
            if(isBiometricAvailable) document.getElementById('bio-row').classList.remove('hidden'); else document.getElementById('bio-row').classList.add('hidden');
        }
        
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function formatNumber(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " "); }
        function toggleTypeFilter(t) { activeType=activeType===t?'all':t; updateUI(); }
        function setDateFilter(f) { activeDate=f; document.querySelectorAll('.date-filter-btn').forEach(b=>b.classList.remove('filter-active')); document.querySelector(`[data-filter="${f}"]`).classList.add('filter-active'); updateUI(); }
        function getDateRange() { const now=new Date(); let s=0,e=now.getTime(); if(activeDate==='week') s=now.getTime()-7*86400000; else if(activeDate==='month') s=new Date(now.getFullYear(),now.getMonth(),1).getTime(); else if(activeDate==='custom') { s=new Date(document.getElementById('start-date').value).getTime(); e=new Date(document.getElementById('end-date').value).getTime()+86400000; } return {s,e}; }
        function openDateRangeModal() { activeDate='custom'; document.getElementById('date-range-modal').classList.remove('hidden'); }
        function applyDateRange() { updateUI(); closeModal('date-range-modal'); }
        function toggleAiSidebar() { const sb = document.getElementById('ai-sidebar'); const m = document.getElementById('gemini-modal'); if(sb.classList.contains('open')) { sb.classList.remove('open'); m.classList.add('hidden'); document.getElementById('ai-toggle-icon').setAttribute('data-lucide','chevron-left'); } else { sb.classList.add('open'); m.classList.remove('hidden'); document.getElementById('ai-toggle-icon').setAttribute('data-lucide','chevron-right'); } lucide.createIcons(); }
        
        async function sendToGemini() { 
            const txt = document.getElementById('ai-input').value; 
            if(!txt) return; 
            const chat = document.getElementById('ai-chat-area'); 
            
            chat.innerHTML += `<div class="msg-wrapper user fade-in"><div class="msg-bubble user">${txt}</div></div>`; 
            document.getElementById('ai-input').value=''; 
            chat.scrollTop = chat.scrollHeight;

            const inc = transactions.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0); 
            const exp = transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0); 
            const prompt = `Balans: ${inc-exp}. Kirim: ${inc}, Chiqim: ${exp}. Savol: ${txt}`; 
            
            try { 
                const res = await fetch(GEMINI_API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})}); 
                const data = await res.json(); 
                const reply = data.candidates[0].content.parts[0].text; 
                chat.innerHTML += `<div class="msg-wrapper ai fade-in"><div class="msg-bubble ai">${reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</div></div>`; 
            } catch(e) { 
                chat.innerHTML += `<div class="msg-wrapper ai fade-in"><div class="msg-bubble ai text-rose-400">Xatolik yuz berdi. Internetni tekshiring.</div></div>`; 
            } 
            chat.scrollTop = chat.scrollHeight;
        }
        
        function openActionSheet(e, id) {
            if(e) e.stopPropagation(); selId = id; const t = transactions.find(x => x.id === id); const c = document.getElementById('action-sheet-content'); c.innerHTML = '';
            if (t.receipt) c.innerHTML += `<button onclick="viewReceipt('${t.receipt}'); closeActionSheet(null)" class="w-full flex items-center gap-3 p-3.5 bg-slate-900/50 rounded-xl hover:bg-slate-900 text-emerald-400 font-medium"><i data-lucide="file-text" class="w-5 h-5"></i> Chekni ko'rish</button>`;
            c.innerHTML += `<button onclick="handleEdit()" class="w-full flex items-center gap-3 p-3.5 bg-slate-900/50 rounded-xl hover:bg-slate-900 text-blue-400 font-medium"><i data-lucide="edit-3" class="w-5 h-5"></i> Tahrirlash</button><button onclick="handleDeleteConfirm()" class="w-full flex items-center gap-3 p-3.5 bg-slate-900/50 rounded-xl hover:bg-slate-900 text-rose-400 font-medium"><i data-lucide="trash-2" class="w-5 h-5"></i> O'chirish</button>`;
            document.getElementById('action-sheet').classList.remove('hidden'); lucide.createIcons();
        }
        function closeActionSheet(e) { if (e && !e.target.closest('.bg-slate-800') && e.target.id!=='action-sheet') return; document.getElementById('action-sheet').classList.add('hidden'); }
        
        function handleDeleteConfirm() { 
            closeActionSheet(null); 
            document.getElementById('delete-modal').classList.remove('hidden'); 
        }
        function confirmDelete() { 
            transactions = transactions.filter(t => t.id !== selId); 
            localStorage.setItem('transactions', JSON.stringify(transactions)); 
            closeModal('delete-modal'); 
            updateUI(); 
        }

        function handleEdit() { closeActionSheet(null); const t = transactions.find(x => x.id === selId); if(!t) return; document.getElementById('edit-category').value=t.category; document.getElementById('edit-amount').value=t.amount; document.getElementById('edit-type').value=t.type; document.getElementById('edit-modal').classList.remove('hidden'); }
        function saveEdit() { const c = document.getElementById('edit-category').value, a = parseInt(document.getElementById('edit-amount').value), tp = document.getElementById('edit-type').value; if(c&&a) { const i = transactions.findIndex(x => x.id === selId); if(i!==-1) { transactions[i].category=c; transactions[i].amount=a; transactions[i].type=tp; localStorage.setItem('transactions', JSON.stringify(transactions)); updateUI(); } } closeModal('edit-modal'); }
        
        // --- FIXED SETTINGS FUNCTIONS ---
        
        function exportData() { 
            // FIXED: Create dynamic link and append to body for reliable download
            const data = { transactions, debts, allCats, pin, bio: bioEnabled };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_kassa_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(e) { 
            // FIXED: Added proper file parsing, saving to localStorage, and reload
            const file = e.target.files[0];
            if (!file) return;
            const r = new FileReader(); 
            r.onload = ev => { 
                try {
                    const d = JSON.parse(ev.target.result); 
                    if(d.transactions) localStorage.setItem('transactions', JSON.stringify(d.transactions)); 
                    if(d.debts) localStorage.setItem('debts', JSON.stringify(d.debts)); 
                    if(d.allCats) localStorage.setItem('categories', JSON.stringify(d.allCats)); 
                    if(d.pin) localStorage.setItem('pin', d.pin); 
                    if(d.bio !== undefined) localStorage.setItem('bio', d.bio); 
                    alert("Ma'lumotlar muvaffaqiyatli tiklandi!");
                    location.reload(); 
                } catch(err) {
                    alert("Xato fayl formati!");
                } 
            }; 
            r.readAsText(file); 
            e.target.value = ''; // Reset input to allow re-importing same file
        }

        function confirmResetData() {
            // NEW FUNCTION: Handles the "Tozalash" action
            if(confirm("DIQQAT! Barcha ma'lumotlar (kirim-chiqim va qarzlar) o'chib ketadi. Davom etasizmi?")) {
                transactions = [];
                debts = [];
                localStorage.setItem('transactions', JSON.stringify([]));
                localStorage.setItem('debts', JSON.stringify([]));
                updateUI();
                alert("Barcha ma'lumotlar tozalandi.");
                closeModal('settings-modal');
            }
        }

        function openDebtModal() { document.getElementById('debt-modal').classList.remove('hidden'); document.getElementById('debt-date').valueAsDate=new Date(); }
        function setDebtType(t) { draft.debtType=t; document.getElementById('btn-type-given').className=t==='given'?'flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-xs':'flex-1 py-3 rounded-xl bg-slate-700 text-slate-400 font-bold text-xs'; document.getElementById('btn-type-taken').className=t==='taken'?'flex-1 py-3 rounded-xl bg-rose-600 text-white font-bold text-xs':'flex-1 py-3 rounded-xl bg-slate-700 text-slate-400 font-bold text-xs'; }
        function saveDebt() { const n=document.getElementById('debt-name').value, a=parseInt(document.getElementById('debt-amount').value), d=document.getElementById('debt-date').value; if(n&&a) { debts.push({id:Date.now(), name:n, amount:a, type:draft.debtType||'given', date:d, completed:false}); localStorage.setItem('debts', JSON.stringify(debts)); closeModal('debt-modal'); switchDebtTab(activeDebt); } }
        function switchDebtTab(t) { activeDebt=t; const list=document.getElementById('debt-list'); list.innerHTML=''; const f=debts.filter(d=>d.type===t && !d.completed); document.getElementById('empty-debt').classList.toggle('hidden', f.length>0); f.forEach(d=>{ list.innerHTML+=`<div class="glass-panel p-3 rounded-xl flex justify-between items-center"><div><div class="text-white font-bold">${d.name}</div><div class="text-xs text-slate-400">${d.date}</div></div><div class="flex gap-2"><div class="font-bold ${t==='given'?'text-blue-400':'text-rose-400'} mr-2">${formatNumber(d.amount)}</div><button onclick="debts.find(x=>x.id===${d.id}).completed=true; localStorage.setItem('debts',JSON.stringify(debts)); switchDebtTab('${t}')" class="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></button></div></div>`; }); document.getElementById('debt-tab-given').className=t==='given'?'flex-1 py-2 text-xs font-bold rounded-lg bg-slate-700 text-white shadow transition-all':'flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 transition-all'; document.getElementById('debt-tab-taken').className=t==='taken'?'flex-1 py-2 text-xs font-bold rounded-lg bg-slate-700 text-white shadow transition-all':'flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 transition-all'; lucide.createIcons(); }
    </script>
</body>
</html>